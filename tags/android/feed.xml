<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Android on xdzhcs</title>
    <link>/tags/android/</link>
    <description>Recent content in Android on xdzhcs</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <lastBuildDate>Sun, 23 Oct 2016 11:50:52 +0800</lastBuildDate>
    <atom:link href="/tags/android/feed/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>activity与service的通信</title>
      <link>/post/Communication-Between-Activity-And-Service/</link>
      <pubDate>Sun, 23 Oct 2016 11:50:52 +0800</pubDate>
      
      <guid>/post/Communication-Between-Activity-And-Service/</guid>
      <description>&lt;p&gt;Activity和Service之间的通信主要有两种形式
1. Binder作为桥梁进行通信
2. 通过广播通信&lt;/p&gt;

&lt;p&gt;###通过Binder通信
我们知道启动一个Service可以使用startService方法或者bindService方法。
来看看bindService方法&lt;br /&gt;
&lt;code&gt;boolean bindService (Intent service, ServiceConnection conn, int flags)&lt;/code&gt;&lt;br /&gt;
第二个参数是一个ServiceConnection对象，里面有两个必须重写的方法&lt;br /&gt;
&lt;code&gt;public void onServiceDisconnected(ComponentName name)&lt;/code&gt;&lt;br /&gt;
&lt;code&gt;public void onServiceConnected(ComponentName name, IBinder service)&lt;/code&gt;&lt;br /&gt;
在bindService绑定Service之后会自动调用onServiceConnected方法,参数里有个IBinder对象，我们只需要在Service里面定义好这个IBinder对象(在Service的onBind方法中返回)，我们在Activity中就可以通过它操作Service了。
上代码&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package xyz.xdzhcs.servicedemo;

import android.app.Service;
import android.content.Intent;
import android.os.Binder;
import android.os.IBinder;
import android.support.annotation.Nullable;

/**
 * Created by xdzhcs on 2016/10/23.
 */
public class DownloadService extends Service {

    private int progress=0;

    /**
     * 开始下载(更新progress)
     */
    public void startDownload(){
       new Thread(new Runnable() {
           @Override
           public void run() {
               while (progress&amp;lt;100){
                   //做了一些事情......进度更新了
                   progress++;
                   try {
                       Thread.sleep(1000);
                   } catch (InterruptedException e) {
                       e.printStackTrace();
                   }
               }
           }
       }).start();
    }

    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        return new MyBinder();
    }
    class MyBinder extends Binder{
        public void startDownload(){
            DownloadService.this.startDownload();
        }
        public int getProgress(){
            return progress;
        }
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;package xyz.xdzhcs.servicedemo;

import android.content.ComponentName;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.IBinder;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.widget.Toast;

public class MainActivity extends AppCompatActivity {

    private DownloadService.MyBinder binder;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        //绑定Service
        Intent intent=new Intent(this,DownloadService.class);
        bindService(intent,conn,BIND_AUTO_CREATE);

        //开始下载
        findViewById(R.id.btn_start_download).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                binder.startDownload();
                Toast.makeText(MainActivity.this,&amp;quot;已经开始下载&amp;quot;,Toast.LENGTH_SHORT).show();
            }
        });

        //获取当前下载进度
        findViewById(R.id.btn_get_progress).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                int progress=binder.getProgress();
                Toast.makeText(MainActivity.this,&amp;quot;当前下载进度：&amp;quot;+progress,Toast.LENGTH_SHORT).show();
            }
        });
    }
    ServiceConnection conn=new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName componentName, IBinder iBinder) {
            binder= (DownloadService.MyBinder) iBinder;
            Toast.makeText(MainActivity.this,&amp;quot;绑定成功&amp;quot;,Toast.LENGTH_SHORT);
        }

        @Override
        public void onServiceDisconnected(ComponentName componentName) {

        }
    };
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;点击开始下载，然后每点一次获取进度就可以调用binder中的getProgress方法返回当前进度了，效果如下。
！[](&lt;a href=&#34;http://blog.xdzhcs.xyz/img/Communication-Between-Activity-And-Service/img1.png&#34;&gt;http://blog.xdzhcs.xyz/img/Communication-Between-Activity-And-Service/img1.png&lt;/a&gt;)
！[](&lt;a href=&#34;http://blog.xdzhcs.xyz/img/Communication-Between-Activity-And-Service/img2.png&#34;&gt;http://blog.xdzhcs.xyz/img/Communication-Between-Activity-And-Service/img2.png&lt;/a&gt;)
所以到目前为止，已经实现了从Activity操纵Service了，但是这种获取进度的方法也太不优雅了吧，有没有方法可以让Service主动通知Activity下载进度呢？当然有，那就是：回调！
定义一个接口&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;public interface OnProgressListener {
    void onProgressChanged(int progress);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在Service里放一个接口的实例&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;private OnProgressListener listener;

    public void setListener(OnProgressListener listener) {
        this.listener = listener;
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;在Activity中实现这个接口&lt;/p&gt;

&lt;pre&gt;&lt;code&gt; binder.setListener(new OnProgressListener() {
                @Override
                public void onProgressChanged(final int progress) {
                    runOnUiThread(new Runnable() {
                        @Override
                        public void run() {
                            Toast.makeText(MainActivity.this,&amp;quot;当前下载进度：&amp;quot;+progress,Toast.LENGTH_SHORT).show();
                        }
                    });

                }
            });
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;每次Service有更新时，就可以通过listener来告诉Activity了
&lt;code&gt;listener.onProgressChanged(progress);&lt;/code&gt;
最后所有的代码看起来是这样的&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package xyz.xdzhcs.servicedemo;

import android.app.Service;
import android.content.Intent;
import android.os.Binder;
import android.os.IBinder;
import android.support.annotation.Nullable;

/**
 * Created by xdzhcs on 2016/10/23.
 */
public class DownloadService extends Service {

    private int progress=0;
    private OnProgressListener listener;

    /**
     * 开始下载(更新progress)
     */
    public void startDownload(){
       new Thread(new Runnable() {
           @Override
           public void run() {
               while (progress&amp;lt;100){
                   //做了一些事情......进度更新了
                   progress++;
                   //通知activity更新进度
                   listener.onProgressChanged(progress);
                   try {
                       Thread.sleep(1000);
                   } catch (InterruptedException e) {
                       e.printStackTrace();
                   }
               }
           }
       }).start();
    }

    @Nullable
    @Override
    public IBinder onBind(Intent intent) {
        return new MyBinder();
    }
    class MyBinder extends Binder{
        public void startDownload(){
            DownloadService.this.startDownload();
        }
        public int getProgress(){
            return progress;
        }
        public void setListener(OnProgressListener listener) {
            DownloadService.this.listener=listener;
        }
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;package xyz.xdzhcs.servicedemo;

import android.content.ComponentName;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.IBinder;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.widget.Toast;

public class MainActivity extends AppCompatActivity {

    private DownloadService.MyBinder binder;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        //绑定Service
        Intent intent=new Intent(this,DownloadService.class);
        bindService(intent,conn,BIND_AUTO_CREATE);

        //开始下载
        findViewById(R.id.btn_start_download).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                binder.startDownload();
                Toast.makeText(MainActivity.this,&amp;quot;已经开始下载&amp;quot;,Toast.LENGTH_SHORT).show();
            }
        });

        //获取当前下载进度
        findViewById(R.id.btn_get_progress).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                int progress=binder.getProgress();
                Toast.makeText(MainActivity.this,&amp;quot;当前下载进度：&amp;quot;+progress,Toast.LENGTH_SHORT).show();
            }
        });
    }
    ServiceConnection conn=new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName componentName, IBinder iBinder) {
            binder= (DownloadService.MyBinder) iBinder;
            Toast.makeText(MainActivity.this,&amp;quot;绑定成功&amp;quot;,Toast.LENGTH_SHORT);
            binder.setListener(new OnProgressListener() {
                @Override
                public void onProgressChanged(final int progress) {
                    runOnUiThread(new Runnable() {
                        @Override
                        public void run() {
                            Toast.makeText(MainActivity.this,&amp;quot;当前下载进度：&amp;quot;+progress,Toast.LENGTH_SHORT).show();
                        }
                    });

                }
            });
        }

        @Override
        public void onServiceDisconnected(ComponentName componentName) {

        }
    };
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;这样就能自动更新进度了。
未完待续&amp;hellip;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>你好,hugo</title>
      <link>/post/first/</link>
      <pubDate>Wed, 24 Aug 2016 21:13:10 +0800</pubDate>
      
      <guid>/post/first/</guid>
      <description>

&lt;h3 id=&#34;你好-hugo&#34;&gt;你好,hugo&lt;/h3&gt;

&lt;p&gt;这是我的第一篇文章，好吧，测试文章。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>